1. Основные проблемы текущей архитектуры

1.1. Высокая зависимость от REST API при интеграции

Взаимодействие сервисов core-app и ins-comp-settlement с ins-product-aggregator синхронное (REST API), что:

Приводит к задержкам в ответах, особенно при росте числа страховых компаний.

Увеличивает вероятность отказов из-за таймаутов и нестабильности API страховых компаний.

1.2. Задержки при формировании реестра оформленных страховок

ins-comp-settlement запрашивает данные у core-app раз в сутки, из-за чего:

Взаиморасчёты происходят с задержкой.

В случае ошибки REST-запроса требуется ручной перезапуск, увеличивая время обработки данных.

1.3. Устаревшие локальные копии данных

core-app обновляет реплику данных о продуктах каждые 15 минут.

ins-comp-settlement обновляет свои данные раз в сутки.

В реальных условиях клиенты и партнёры могут получать неактуальные тарифы и условия, что может привести к:

Неправильному расчёту стоимости страховки.

Ошибкам при оформлении заявок.

1.4. Планируемый рост страховых компаний увеличит нагрузку

Сейчас агрегатор запрашивает данные от 5 компаний.

В ближайшее время ожидается рост до 10 компаний.

Это удвоит время отклика ins-product-aggregator и увеличит вероятность таймаутов.

2. Предложенные решения и переход на Event-Driven архитектуру

2.1. Использование Event-Streaming вместо REST-запросов

core-app и ins-comp-settlement больше не запрашивают напрямую данные о продуктах.

Вместо этого ins-product-aggregator публикует обновления продуктов в Kafka (или RabbitMQ).

core-app и ins-comp-settlement подписаны на этот поток и получают обновления в реальном времени.

Это устраняет задержки и избыточные запросы.

2.2. Асинхронное обновление оформленных страховок

Вместо запроса от ins-comp-settlement к core-app раз в сутки:

core-app публикует события оформления страховки в Kafka.

ins-comp-settlement подписан на этот топик и обрабатывает данные по мере их появления.

Это позволяет:

Сократить задержки во взаиморасчетах.

Снизить риск сбоев из-за проблем с REST API.

2.3. Transactional Outbox для консистентности данных

Используем паттерн Transactional Outbox, чтобы избежать несогласованности данных:

core-app сначала фиксирует изменения в БД.

Затем публикует событие в Event Stream (Kafka) атомарно.

Это гарантирует, что событие не будет потеряно даже при сбое API Kafka.

Подход также применяется в ins-product-aggregator и ins-comp-settlement.

3. Ожидаемые результаты

✅ Снижение времени отклика: данные обновляются в реальном времени, а не по расписанию.
✅ Повышенная отказоустойчивость: REST-запросы заменяются асинхронными событиями.
✅ Масштабируемость: можно добавлять новые страховые компании без увеличения задержек.
✅ Снижение нагрузки на агрегатор: больше не требуется собирать данные синхронно при каждом запросе.
✅ Более точные расчёты: клиенты всегда получают актуальные тарифы.